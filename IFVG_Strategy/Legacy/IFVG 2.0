//@version=5
indicator("IFVG 2.0 - Inversion Fair Value Gaps [Mejorado]", "IFVG 2.0", overlay = true, max_boxes_count = 500, max_lines_count = 500, max_labels_count = 500)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“˜ EXPLICACIÃ“N FÃCIL - Â¿QUÃ‰ ES ESTO?
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
IFVG = Inversion Fair Value Gaps (Huecos de Valor Justo con InversiÃ³n)

Â¿QuÃ© hace este indicador?
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. DETECTA "Fair Value Gaps" (FVG) - Huecos en el precio donde NO hubo negociaciÃ³n
   
   Ejemplo FVG Alcista:
   â”‚      â”Œâ”€â”€â”€ Vela 3 (actual)
   â”‚      â”‚    
   â”‚    â”Œâ”€â”´â”€â”
   â”‚    â”‚   â”‚
   â”‚    â””â”€â”€â”€â”˜
   â”‚      â†‘
   â”‚      â”‚ [HUECO/GAP] â† Zona sin negociaciÃ³n (FVG)
   â”‚      â†“
   â”‚  â”Œâ”€â”€â”€â”€â”€â”
   â”‚  â”‚     â”‚  Vela 1
   â”‚  â””â”€â”€â”€â”€â”€â”˜
   
   Entre el high de Vela 1 y el low de Vela 3 hay un HUECO = Fair Value Gap

2. ESPERA LA "INVERSIÃ“N" del FVG
   - FVG Alcista se invierte cuando el precio CAE y toca el hueco
   - FVG Bajista se invierte cuando el precio SUBE y toca el hueco
   
3. GENERA SEÃ‘ALES cuando el precio rebota desde la zona de inversiÃ³n
   - â–² SeÃ±al alcista = Precio tocÃ³ FVG invertido y rebotÃ³ hacia arriba
   - â–¼ SeÃ±al bajista = Precio tocÃ³ FVG invertido y rebotÃ³ hacia abajo

Â¿Por quÃ© funciona?
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- El mercado tiende a LLENAR los huecos (volver al precio justo)
- Estos huecos actÃºan como zonas de soporte/resistencia
- Cuando se invierten, el precio tiende a rebotar desde ahÃ­
*/

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ CONFIGURACIÃ“N PRINCIPAL
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grupo_deteccion = "ğŸ” DetecciÃ³n de FVG"

disp_num = input.int(10, 
     title = "Cantidad a Mostrar", 
     minval = 1, 
     maxval = 100, 
     group = grupo_deteccion,
     tooltip = "NÃºmero de FVGs invertidos (pares alcista/bajista) a mostrar en el grÃ¡fico.\n\n" +
               "â€¢ Mayor valor = MÃ¡s zonas histÃ³ricas visibles\n" +
               "â€¢ Menor valor = Solo las mÃ¡s recientes\n\n" +
               "Recomendado: 5-10 para grÃ¡ficos limpios, 20-50 para anÃ¡lisis profundo")

signal_pref = input.string("Close", 
     title = "Preferencia de SeÃ±al", 
     options = ["Close","Wick"], 
     group = grupo_deteccion,
     tooltip = "Define QUÃ‰ precio debe tocar el FVG para generar seÃ±al:\n\n" +
               "â€¢ Close (Cierre) = La vela debe CERRAR en la zona FVG (mÃ¡s conservador)\n" +
               "â€¢ Wick (Mecha) = Basta que la mecha TOQUE la zona FVG (mÃ¡s sensible)\n\n" +
               "Close = menos seÃ±ales pero mÃ¡s confiables\n" +
               "Wick = mÃ¡s seÃ±ales pero pueden ser falsas")

wt = signal_pref == "Wick"

atr_multi = input.float(0.5, 
     title = "Multiplicador ATR (Filtro)", 
     minval = 0,
     step = 0.1,
     group = grupo_deteccion,
     tooltip = "Filtra FVGs pequeÃ±os usando volatilidad (ATR).\n\n" +
               "Solo muestra FVGs cuyo tamaÃ±o sea > (ATR Ã— Multiplicador)\n\n" +
               "â€¢ 0 = Muestra TODOS los FVGs (incluso muy pequeÃ±os)\n" +
               "â€¢ 0.25 = Filtro suave (muchos FVGs)\n" +
               "â€¢ 0.5 = Filtro medio (recomendado)\n" +
               "â€¢ 1.0+ = Filtro estricto (solo FVGs grandes)\n\n" +
               "Mayor valor = Solo FVGs significativos (menos ruido)")

atr_length = input.int(300,
     title = "Longitud ATR",
     minval = 10,
     maxval = 500,
     group = grupo_deteccion,
     tooltip = "PerÃ­odo para calcular el ATR (Average True Range).\n\n" +
               "â€¢ Menor (50-100) = ATR mÃ¡s reactivo a volatilidad reciente\n" +
               "â€¢ Mayor (200-300) = ATR mÃ¡s suave, promedio de largo plazo\n\n" +
               "Valor por defecto: 200 (estÃ¡ndar para FVGs)")

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grupo_memoria = "ğŸ’¾ GestiÃ³n de Memoria"

buffer_size = input.int(100, 
     title = "TamaÃ±o del Buffer (Memoria)",
     minval = 20,
     maxval = 500,
     step = 10,
     group = grupo_memoria,
     tooltip = "NÃºmero MÃXIMO de FVGs que se guardan en memoria.\n\n" +
               "Â¿QuÃ© hace?\n" +
               "â€¢ Almacena los Ãºltimos N FVGs detectados\n" +
               "â€¢ Cuando se llena, elimina el mÃ¡s antiguo (FIFO)\n\n" +
               "Â¿Por quÃ© es importante?\n" +
               "â€¢ MÃ¡s memoria = MÃ¡s datos histÃ³ricos, pero mÃ¡s lento\n" +
               "â€¢ Menos memoria = MÃ¡s rÃ¡pido, pero pierde historial\n\n" +
               "Recomendado:\n" +
               "â€¢ Scalping/Daytrading: 50-100\n" +
               "â€¢ Swing Trading: 100-200\n" +
               "â€¢ AnÃ¡lisis largo plazo: 200-500\n\n" +
               "âš ï¸ Valores muy altos pueden hacer el script mÃ¡s lento")

max_extension = input.int(50,
     title = "ExtensiÃ³n MÃ¡xima (Barras)",
     minval = 10,
     maxval = 200,
     step = 5,
     group = grupo_memoria,
     tooltip = "NÃºmero de barras hacia la DERECHA que se extiende el FVG.\n\n" +
               "â€¢ Afecta cuÃ¡nto tiempo permanece visible la zona en el futuro\n" +
               "â€¢ Mayor valor = Zona se extiende mÃ¡s hacia adelante\n\n" +
               "Ãštil para:\n" +
               "â€¢ Ver zonas clave en el futuro\n" +
               "â€¢ Anticipar donde puede reaccionar el precio\n\n" +
               "Recomendado: 30-50 barras")

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grupo_colores = "ğŸ¨ Colores y Estilo"

green = input.color(color.new(#089981, 80), 
     title = "Color Alcista (Bull)", 
     group = grupo_colores,
     tooltip = "Color para FVGs alcistas (zonas de soporte potencial)")

red = input.color(color.new(#f23645, 80), 
     title = "Color Bajista (Bear)", 
     group = grupo_colores,
     tooltip = "Color para FVGs bajistas (zonas de resistencia potencial)")

gray = input.color(#787b86, 
     title = "Color LÃ­nea Media", 
     group = grupo_colores,
     tooltip = "Color de la lÃ­nea discontinua que marca el centro del FVG")

invis = color.rgb(0,0,0,100)

show_labels = input.bool(true,
     title = "Mostrar SeÃ±ales (â–²â–¼)",
     group = grupo_colores,
     tooltip = "Muestra/oculta las flechas de seÃ±al cuando el precio rebota desde un FVG")

label_size = input.string("normal",
     title = "TamaÃ±o de SeÃ±ales",
     options = ["tiny", "small", "normal", "large"],
     group = grupo_colores,
     tooltip = "TamaÃ±o de las flechas â–² y â–¼ que marcan las seÃ±ales de trading")

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grupo_visual = "ğŸ‘ï¸ VisualizaciÃ³n"

show_future_extension = input.bool(true,
     title = "Mostrar ExtensiÃ³n Futura",
     group = grupo_visual,
     tooltip = "Extiende las zonas FVG hacia la derecha del grÃ¡fico.\n\n" +
               "â€¢ Activado = Puedes ver las zonas proyectadas hacia adelante\n" +
               "â€¢ Desactivado = Solo muestra el perÃ­odo histÃ³rico donde ocurriÃ³ el FVG")

show_midline = input.bool(true,
     title = "Mostrar LÃ­nea Media",
     group = grupo_visual,
     tooltip = "Muestra una lÃ­nea discontinua en el centro del FVG.\n\n" +
               "Ãštil para:\n" +
               "â€¢ Identificar el precio 'justo' del gap\n" +
               "â€¢ Usar como objetivo de entrada en el punto medio")

transparency = input.int(80,
     title = "Transparencia de Zonas",
     minval = 0,
     maxval = 95,
     step = 5,
     group = grupo_visual,
     tooltip = "Transparencia de las cajas FVG (0-95).\n\n" +
               "â€¢ 0 = Completamente opaco (sÃ³lido)\n" +
               "â€¢ 50 = Semi-transparente\n" +
               "â€¢ 90+ = Casi invisible\n\n" +
               "Recomendado: 70-85 para visibilidad clara sin ocultar velas")

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grupo_alertas = "ğŸ”” ConfiguraciÃ³n de Alertas"

alert_bull = input.bool(true,
     title = "Alertas Alcistas",
     group = grupo_alertas,
     tooltip = "Genera alerta cuando aparece seÃ±al alcista â–²")

alert_bear = input.bool(true,
     title = "Alertas Bajistas",
     group = grupo_alertas,
     tooltip = "Genera alerta cuando aparece seÃ±al bajista â–¼")

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š ESTRUCTURAS DE DATOS (UDT - User Defined Types)
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Estructura para almacenar datos de las etiquetas/seÃ±ales
type lab
    int x        // PosiciÃ³n temporal (time)
    float y      // Precio donde aparece la seÃ±al
    int dir      // DirecciÃ³n: 1 = alcista, -1 = bajista

// Estructura principal que contiene TODA la informaciÃ³n de un FVG
type fvg
    int left = na        // Barra donde INICIA el FVG
    float top = na       // Precio SUPERIOR del FVG
    int right = na       // Barra donde TERMINA el FVG
    float bot = na       // Precio INFERIOR del FVG
    float mid = na       // Precio MEDIO del FVG (para lÃ­nea central)
    int dir = na         // DirecciÃ³n original: 1 = bull, -1 = bear
    int state = na       // Estado: 0 = nuevo, 1 = invertido
    array<lab> labs = na // Array de seÃ±ales generadas por este FVG
    int x_val = na       // Valor temporal de inversiÃ³n

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ FUNCIONES PRINCIPALES
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// CÃ¡lculos bÃ¡sicos de velas
c_top = math.max(open, close)  // Tope del cuerpo de la vela
c_bot = math.min(open, close)  // Base del cuerpo de la vela

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FunciÃ³n: Crear etiquetas de seÃ±al (â–² o â–¼)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
label_maker(_x, _y, _dir) =>
    if not show_labels
        label(na)  // No crear label si estÃ¡ desactivado
    else
        _size = switch label_size
            "tiny" => size.tiny
            "small" => size.small
            "normal" => size.normal
            "large" => size.large
            => size.small
        
        switch
            _dir == 1 => 
                label.new(_x, _y, "\nâ–²", 
                     style = label.style_text_outline, 
                     color = invis, 
                     textcolor = color.new(green, 0), 
                     size = _size, 
                     xloc = xloc.bar_time)
            _dir == -1 => 
                label.new(_x, _y, "â–¼\n", 
                     style = label.style_text_outline, 
                     color = invis, 
                     textcolor = color.new(red, 0), 
                     size = _size, 
                     xloc = xloc.bar_time)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FunciÃ³n: Gestionar FVGs y detectar inversiones
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Filtra FVGs y los mueve al array de inversiones cuando se tocan
fvg_manage(_ary, _inv_ary) =>
    // Limitar tamaÃ±o del buffer
    if _ary.size() >= buffer_size
        _ary.shift()  // Eliminar el FVG mÃ¡s antiguo

    if _ary.size() > 0
        // Revisar cada FVG en el array
        for i = _ary.size() - 1 to 0
            value = _ary.get(i)
            _dir = value.dir

            // INVERSIÃ“N ALCISTA: Precio cae POR DEBAJO del FVG alcista
            if _dir == 1 and (c_bot < value.bot)
                value.x_val := time
                _inv_ary.push(_ary.remove(i))  // Mover a array de inversiones
            
            // INVERSIÃ“N BAJISTA: Precio sube POR ENCIMA del FVG bajista
            if _dir == -1 and (c_top > value.top)
                value.x_val := time
                _inv_ary.push(_ary.remove(i))

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FunciÃ³n: Gestionar inversiones y generar seÃ±ales
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
inv_manage(_ary) =>
    fire = false  // Flag para detectar nueva seÃ±al
    
    // Limitar tamaÃ±o del buffer
    if _ary.size() >= buffer_size
        _ary.shift()
    
    if _ary.size() > 0
        for i = _ary.size() - 1 to 0
            value = _ary.get(i)
            bx_top = value.top
            bx_bot = value.bot
            _dir = value.dir
            st = value.state

            // CAMBIAR ESTADO: Marcar como "invertido" y cambiar direcciÃ³n esperada
            if (st == 0 and _dir == 1)
                value.state := 1
                value.dir := -1  // Ahora espera seÃ±al bajista
            if (_dir == -1 and st == 0)
                value.state := 1
                value.dir := 1   // Ahora espera seÃ±al alcista
            
            // Actualizar extensiÃ³n temporal
            if st >= 1
                value.right := time

            // SEÃ‘AL BAJISTA: Precio toca FVG invertido desde arriba y cae
            if (_dir == -1 and st == 1 and close < bx_bot and 
                 (wt ? high : close[1]) >= bx_bot and 
                 (wt ? high : close[1]) < bx_top)
                value.labs.push(lab.new(time, bx_top, -1))
                fire := true

            // SEÃ‘AL ALCISTA: Precio toca FVG invertido desde abajo y sube
            if (_dir == 1 and st == 1 and close > bx_top and 
                 (wt ? low : close[1]) <= bx_top and 
                 (wt ? low : close[1]) > bx_bot)
                value.labs.push(lab.new(time, bx_bot, 1))
                fire := true

            // ELIMINAR FVG: Si el precio rompe completamente la zona
            if st >= 1 and ((_dir == -1 and c_top > bx_top) or 
                           (_dir == 1 and c_bot < bx_bot))
                _ary.remove(i)
    
    fire  // Retorna true si hubo seÃ±al

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FunciÃ³n: Dibujar FVGs en el grÃ¡fico
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
send_it(_ary) =>
    last_index = _ary.size() - 1
    
    for [index, value] in _ary
        bx_top = value.top
        bx_bot = value.bot
        bx_left = value.left
        xval = value.x_val
        mid = value.mid
        col = value.dir == -1 ? green : red  // Color segÃºn direcciÃ³n
        o_col = value.dir == -1 ? red : green  // Color opuesto (invertido)

        // Solo mostrar los Ãºltimos N FVGs
        if index > last_index - disp_num
            // Caja ANTES de la inversiÃ³n (color original)
            box.new(bx_left, bx_top, xval, bx_bot, 
                 bgcolor = color.new(col, transparency), 
                 border_color = invis, 
                 xloc = xloc.bar_time)
            
            // Caja DESPUÃ‰S de la inversiÃ³n (color opuesto)
            box.new(xval, bx_top, time, bx_bot, 
                 bgcolor = color.new(o_col, transparency), 
                 border_color = invis, 
                 xloc = xloc.bar_time)

            // LÃ­nea media (histÃ³rica)
            if show_midline
                line.new(bx_left, mid, time, mid, 
                     color = gray, 
                     style = line.style_dashed, 
                     xloc = xloc.bar_time)
            
            // ExtensiÃ³n futura (derecha del grÃ¡fico)
            if show_future_extension
                box.new(bar_index, bx_top, bar_index + max_extension, bx_bot, 
                     bgcolor = color.new(o_col, transparency), 
                     border_color = invis)
                
                if show_midline
                    line.new(bar_index, mid, bar_index + max_extension, mid, 
                         color = gray, 
                         style = line.style_dashed)

            // Dibujar seÃ±ales (â–² â–¼)
            for stuff in value.labs
                label_maker(stuff.x, stuff.y, stuff.dir)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ—‘ï¸ LIMPIAR DIBUJOS PREVIOS (Importante para rendimiento)
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
for boxes in box.all
    box.delete(boxes)

for lines in line.all
    line.delete(lines)

for labels in label.all
    label.delete(labels)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’¾ ARRAYS DE DATOS (Almacenamiento en memoria)
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var bull_fvg_ary = array.new<fvg>(na)  // FVGs alcistas detectados  (no todos mostrados)
var bear_fvg_ary = array.new<fvg>(na)  // FVGs bajistas detectados (no todos mostrados)

var bull_inv_ary = array.new<fvg>(na)  // FVGs alcistas INVERTIDOS (todos mostrados)
var bear_inv_ary = array.new<fvg>(na)  // FVGs bajistas INVERTIDOS (todos mostrados)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” DETECCIÃ“N DE FVG (LÃ³gica Principal)
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Calcular ATR para filtro de tamaÃ±o
atr = nz(ta.atr(atr_length) * atr_multi, ta.cum(high - low) / (bar_index + 1))

// CONDICIÃ“N FVG ALCISTA:
// El low actual > high de hace 2 velas Y close de vela previa > high de hace 2 velas
fvg_up = (low > high[2]) and (close[1] > high[2])

// CONDICIÃ“N FVG BAJISTA:
// El high actual < low de hace 2 velas Y close de vela previa < low de hace 2 velas
fvg_down = (high < low[2]) and (close[1] < low[2])

// CREAR FVG ALCISTA si cumple condiciones Y es lo suficientemente grande
if fvg_up and math.abs(low - high[2]) > atr
    array.push(bull_fvg_ary, 
         fvg.new(
              time[1],                      // left: inicio del FVG
              low,                          // top: precio superior
              time,                         // right: fin del FVG
              high[2],                      // bot: precio inferior
              math.avg(low, high[2]),       // mid: precio medio
              1,                            // dir: alcista
              0,                            // state: nuevo
              array.new<lab>(na),           // labs: array vacÃ­o de seÃ±ales
              na))                          // x_val: sin inversiÃ³n aÃºn

// CREAR FVG BAJISTA si cumple condiciones Y es lo suficientemente grande
if fvg_down and math.abs(low[2] - high) > atr
    array.push(bear_fvg_ary, 
         fvg.new(
              time[1],                      // left
              low[2],                       // top
              time,                         // right
              high,                         // bot
              math.avg(high, low[2]),       // mid
              -1,                           // dir: bajista
              0,                            // state: nuevo
              array.new<lab>(na),           // labs
              na))                          // x_val

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ EJECUTAR FUNCIONES (Procesamiento en cada barra)
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Paso 1: Gestionar FVGs y detectar inversiones
fvg_manage(bull_fvg_ary, bull_inv_ary)
fvg_manage(bear_fvg_ary, bear_inv_ary)

// Paso 2: Gestionar inversiones y generar seÃ±ales
bear_signal = inv_manage(bull_inv_ary)  // FVG alcista invertido â†’ seÃ±al bajista
bull_signal = inv_manage(bear_inv_ary)  // FVG bajista invertido â†’ seÃ±al alcista

// Paso 3: Dibujar en el grÃ¡fico (solo en Ãºltima barra)
if barstate.islast
    send_it(bull_inv_ary)
    send_it(bear_inv_ary)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”” ALERTAS
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(bull_signal and alert_bull, 
     "SeÃ±al Alcista IFVG", 
     "ğŸŸ¢ SEÃ‘AL ALCISTA: Precio rebotÃ³ desde FVG invertido â–²")

alertcondition(bear_signal and alert_bear, 
     "SeÃ±al Bajista IFVG", 
     "ğŸ”´ SEÃ‘AL BAJISTA: Precio rebotÃ³ desde FVG invertido â–¼")

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ NOTAS FINALES
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
FLUJO DEL INDICADOR:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. Detectar FVG â†’ Guardar en array (bull_fvg_ary o bear_fvg_ary)
2. Esperar inversiÃ³n â†’ Mover a array de inversiones (bull_inv_ary o bear_inv_ary)
3. Monitorear rebotes â†’ Generar seÃ±ales (â–² o â–¼)
4. Dibujar â†’ Mostrar zonas y seÃ±ales en el grÃ¡fico
5. Eliminar â†’ Borrar FVGs rotos o muy antiguos

ADMINISTRACIÃ“N DE MEMORIA:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- Buffer de 100 FVGs (configurable)
- Sistema FIFO: Primero en entrar, primero en salir
- Elimina FVGs cuando:
  * Se llena el buffer
  * El precio los rompe completamente
  * Ya no son relevantes

OPTIMIZACIONES:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- Limpieza de dibujos en cada barra
- Filtro ATR para ignorar FVGs pequeÃ±os
- Solo dibuja en Ãºltima barra (barstate.islast)
- LÃ­mite de objetos: 500 cajas, 500 lÃ­neas, 500 etiquetas
*/
